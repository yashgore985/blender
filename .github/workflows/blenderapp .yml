name: Blender Android Build

on:
  workflow_dispatch:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    name: Build Blender for Android (arm64-v8a)
    runs-on: ubuntu-latest

    env:
      ANDROID_NDK_VERSION: r25c
      BLENDER_BRANCH: main

    steps:

    - name: Set up Git
      run: |
        git config --global advice.detachedHead false

    - name: Checkout Blender source
      uses: actions/checkout@v3
      with:
        repository: blender/blender
        ref: ${{ env.BLENDER_BRANCH }}
        submodules: true
        path: blender-source

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git cmake ninja-build gcc g++ python3-pip unzip wget openjdk-11-jdk
        python3 -m pip install --upgrade pip setuptools

    - name: Install Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: ${{ env.ANDROID_NDK_VERSION }}
        add-to-path: true

    - name: Clone & update all submodules
      run: |
        cd blender-source
        make update
        git submodule update --init --recursive

    - name: Build Blender for Android (arm64)
      run: |
        cd blender-source
        make android_arm64_release -j$(nproc)

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: blender-android-arm64
        path: blender-source/build_android_arm64_release/bin/*.apk
