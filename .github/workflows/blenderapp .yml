name: Blender Android Build

on:
  workflow_dispatch:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    name: Build Blender Android
    runs-on: ubuntu-latest

    env:
      ANDROID_NDK_VERSION: r25c
      ANDROID_API_LEVEL: 24
      ANDROID_ABI: arm64-v8a
      BLENDER_BRANCH: main

    steps:
    - name: Checkout Blender source
      uses: actions/checkout@v3
      with:
        repository: blender/blender
        ref: ${{ env.BLENDER_BRANCH }}
        submodules: true

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y git cmake ninja-build gcc g++ python3-pip
        python3 -m pip install --upgrade pip setuptools

    - name: Clone Blender Android dependencies
      run: |
        git clone https://projects.blender.org/blender/blender.git blender-source
        cd blender-source
        make update

    - name: Download Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: ${{ env.ANDROID_NDK_VERSION }}
        add-to-path: true

    - name: Set environment variables
      run: |
        echo "ANDROID_HOME=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
        echo "ANDROID_NDK_HOME=$ANDROID_NDK" >> $GITHUB_ENV
        echo "ANDROID_ABI=${{ env.ANDROID_ABI }}" >> $GITHUB_ENV
        echo "ANDROID_API=${{ env.ANDROID_API_LEVEL }}" >> $GITHUB_ENV

    - name: Configure Blender for Android
      run: |
        cd blender-source
        make platform=android arm64_v8a

    - name: Build Blender for Android
      run: |
        cd blender-source
        make platform=android arm64_v8a -j$(nproc)

    - name: Upload APK (optional)
      uses: actions/upload-artifact@v4
      with:
        name: blender-android-arm64
        path: blender-source/build_android_arm64_v8a/bin/*.apk
